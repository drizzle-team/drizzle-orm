name: Release Router

on:
  push:
    branches-ignore:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      target: ${{ steps.route.outputs.target }}

    steps:
      - name: Route release
        id: route
        run: |
          EVENT="${{ github.event_name }}"
          BRANCH="${GITHUB_REF##*/}"

          if [[ "$EVENT" == "workflow_dispatch" && "$BRANCH" == "main" ]]; then
            echo "target=latest" >> $GITHUB_OUTPUT
          else
            echo "target=feature" >> $GITHUB_OUTPUT
          fi

  run-feature:
    needs: detect
    if: needs.detect.outputs.target == 'feature'
    uses: ./.github/workflows/release-feature-branch.yaml

  run-latest:
    needs: detect
    if: needs.detect.outputs.target == 'latest'
    uses: ./.github/workflows/release-latest.yaml