name: Release (feature branch)

on:
  push:
    branches-ignore:
      - main
  pull_request: {}

concurrency:
  group: feature-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare:
    runs-on: ubuntu-24.04
    timeout-minutes: 25
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: 'team_KbvYUtAn1Tqytsj8HbNcYDqV'
    steps:
      - uses: actions/checkout@v5
      - uses: pnpm/action-setup@v4
        with: { run_install: false }
      - uses: actions/setup-node@v6
        with: { node-version: '24', registry-url: 'https://registry.npmjs.org', cache: 'pnpm', cache-dependency-path: pnpm-lock.yaml }
      - run: pnpm install --frozen-lockfile --prefer-offline
      - name: Compute version suffix
        id: meta
        shell: bash
        run: echo "suffix=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
      - name: Build Prisma client
        working-directory: drizzle-orm
        run: pnpm prisma generate --schema src/prisma/schema.prisma
      - name: Build all
        run: pnpm build:artifact
      # Upload compiled JS for tests to reuse
      - name: Upload build-dist
        uses: actions/upload-artifact@v4
        with:
          name: build-dist
          path: |
            **/dist
            **/*.tsbuildinfo
      - name: Pack
        run: pnpm pack:artifact
      - uses: actions/upload-artifact@v4
        with: { name: drizzle-orm, path: drizzle-orm/package.tgz }
      - uses: actions/upload-artifact@v4
        with: { name: drizzle-kit, path: drizzle-kit/package.tgz }
      - uses: actions/upload-artifact@v4
        with: { name: drizzle-zod, path: drizzle-zod/package.tgz }
      - uses: actions/upload-artifact@v4
        with: { name: drizzle-seed, path: drizzle-seed/package.tgz }
      - uses: actions/upload-artifact@v4
        with: { name: drizzle-typebox, path: drizzle-typebox/package.tgz }
      - uses: actions/upload-artifact@v4
        with: { name: drizzle-valibot, path: drizzle-valibot/package.tgz }
      - uses: actions/upload-artifact@v4
        with: { name: drizzle-arktype, path: drizzle-arktype/package.tgz }
      - uses: actions/upload-artifact@v4
        with: { name: eslint-plugin-drizzle, path: eslint-plugin-drizzle/package.tgz }

      # Tiny marker so other jobs can wait without failing
      - name: Upload build-ready marker
        run: mkdir -p .gh && echo "ok" > .gh/build-ready
      - uses: actions/upload-artifact@v4
        with:
          name: build-ready
          path: .gh/build-ready
      - name: test:types & lint
        run: pnpm test:types-lint

  test:
    # NOTE: no 'needs: [prepare]' on purpose — start early, warm DBs, then wait for artifacts
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name != github.repository
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - shard: int:gel
            dbs: [gel]
          - shard: int:singlestore-core
            dbs: [singlestore]
          - shard: int:singlestore-proxy
            dbs: [singlestore]
          - shard: int:singlestore-prefixed
            dbs: [singlestore]
          - shard: int:singlestore-custom
            dbs: [singlestore]
          - shard: int:mysql
            dbs: [mysql]
          - shard: int:postgres
            dbs: [postgres]
          - shard: int:sqlite
            dbs: []
          - shard: int:other
            dbs: [mysql, mssql, cockroach, singlestore]
          - shard: int:planetscale
            dbs: []
          - shard: int:cockroach
            dbs: [cockroach]
          - shard: int:bun
            dbs: [postgres, mysql]
          - shard: int:mssql
            dbs: [mssql]
          - shard: orm
            dbs: []
          - shard: kit
            dbs: [postgres, mysql, mssql, cockroach]
          - shard: kit:cockroach
            dbs: [cockroach]
          - shard: kit:mssql
            dbs: [mssql]
          - shard: zod
            dbs: []
          - shard: seed
            dbs: [cockroach, mysql, mssql, postgres-postgis, singlestore]
          - shard: typebox
            dbs: []
          - shard: valibot
            dbs: []
          - shard: arktype
            dbs: []
         
    name: ${{ matrix.shard }}
    steps:
      - uses: actions/checkout@v5
      - uses: pnpm/action-setup@v4
        with: { run_install: false }
      - uses: actions/setup-node@v6
        with: { node-version: '24', registry-url: 'https://registry.npmjs.org', cache: 'pnpm', cache-dependency-path: pnpm-lock.yaml }
      - run: pnpm install --frozen-lockfile --prefer-offline

      - name: Start DBs needed by shard (pre-warm)
        if: ${{ matrix.dbs && join(matrix.dbs, ',') != '' }}
        shell: bash
        run: |
          set -euxo pipefail
          for db in ${{ join(matrix.dbs, ' ') }}; do
            case "$db" in
              postgres)            docker compose -f compose/postgres.yml up -d ;;
              postgres-postgis)    docker compose -f compose/postgres-postgis.yml up -d ;;
              mysql)               docker compose -f compose/mysql.yml up -d ;;
              singlestore)         docker compose -f compose/singlestore.yml up -d ;;
              mssql)               docker compose -f compose/mssql.yml up -d ;;
              cockroach)           docker compose -f compose/cockroach.yml up -d ;;
              gel)                 docker compose -f compose/gel.yml up -d ;;
              *) echo "Unknown db '$db'"; exit 1 ;;
            esac
          done
          chmod +x compose/wait.sh
          compose/wait.sh ${{ join(matrix.dbs, ' ') }}

      - name: Wait for 'prepare' to finish (poll artifact)
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          run_id="${{ github.run_id }}"
          repo="${{ github.repository }}"
          echo "Waiting for 'build-ready' artifact from prepare job in run $run_id..."
          for i in $(seq 1 120); do
            artifacts_json="$(curl -fsSL -H "Authorization: Bearer $GH_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${repo}/actions/runs/${run_id}/artifacts")"
            echo "$artifacts_json" | jq -e '.artifacts[] | select(.name=="build-ready")' >/dev/null 2>&1 && { echo "build-ready found"; break; }
            echo "…still waiting ($i/120)"
            sleep 5
          done

      - name: Download build-dist (compiled JS)
        uses: actions/download-artifact@v4
        with:
          name: build-dist
          path: .

      # Prisma client was generated in prepare -> build outputs already contain it
      # No `pnpm build` here — we reuse dist to save time

      - uses: oven-sh/setup-bun@v2
      - name: Run tests
        env:
          PG_CONNECTION_STRING: postgres://postgres:postgres@localhost:55433/drizzle
          PG_VECTOR_CONNECTION_STRING: postgres://postgres:postgres@localhost:54321/drizzle
          PG_POSTGIS_CONNECTION_STRING: postgres://postgres:postgres@localhost:54322/drizzle
          MYSQL_CONNECTION_STRING: mysql://root:mysql@localhost:3306/drizzle
          PLANETSCALE_CONNECTION_STRING: ${{ secrets.PLANETSCALE_CONNECTION_STRING }}
          NEON_CONNECTION_STRING: ${{ secrets.NEON_CONNECTION_STRING }}
          TIDB_CONNECTION_STRING: ${{ secrets.TIDB_CONNECTION_STRING }}
          XATA_API_KEY: ${{ secrets.XATA_API_KEY }}
          XATA_BRANCH: ${{ secrets.XATA_BRANCH }}
          LIBSQL_URL: file:local.db
          LIBSQL_REMOTE_URL: ${{ secrets.LIBSQL_REMOTE_URL }}
          LIBSQL_REMOTE_TOKEN: ${{ secrets.LIBSQL_REMOTE_TOKEN }}
          GEL_CONNECTION_STRING: gel://admin:password@localhost:56565/main
          SINGLESTORE_CONNECTION_STRING: singlestore://root:singlestore@localhost:33307/
          COCKROACH_CONNECTION_STRING: postgresql://root@127.0.0.1:26257/defaultdb?sslmode=disable
          MSSQL_CONNECTION_STRING: mssql://SA:drizzle123PASSWORD!@localhost:1433?encrypt=true&trustServerCertificate=true
          TEST_CONFIG_PATH_PREFIX: ./tests/cli/
        working-directory: integration-tests
        shell: bash
        run: |
          set -euxo pipefail
          if [[ ${{ github.event_name }} != "push" && "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]]; then
            export SKIP_EXTERNAL_DB_TESTS=1
          fi
          case ${{ matrix.shard }} in
            int:gel)
              if [[ -z "${SKIP_EXTERNAL_DB_TESTS:-}" ]]; then
                pnpm --stream vitest --reporter=verbose --silent=false run tests/gel
              fi
            ;;
            int:singlestore-core) pnpm --stream vitest --reporter=verbose --silent=false run tests/singlestore/singlestore.test.ts ;;
            int:singlestore-proxy) pnpm --stream vitest --reporter=verbose --silent=false run tests/singlestore/singlestore-proxy.test.ts ;;
            int:singlestore-prefixed) pnpm --stream vitest --reporter=verbose --silent=false run tests/singlestore/singlestore-prefixed.test.ts ;;
            int:singlestore-custom) pnpm --stream vitest --reporter=verbose --silent=false run tests/singlestore/singlestore-custom.test.ts ;;
            int:postgres)
              if [[ -z "${SKIP_EXTERNAL_DB_TESTS:-}" ]]; then
                pnpm --stream vitest --reporter=verbose --silent=false run tests/pg/
              fi
            ;;
            int:mysql)
              pnpm --stream test:mysql
            ;;
            int:tidb)
              if [[ -z "${SKIP_EXTERNAL_DB_TESTS:-}" ]]; then
                pnpm --stream vitest --reporter=verbose --silent=false tests/mysql/tidb
              fi
            ;;
            int:planetscale)
              if [[ -z "${SKIP_EXTERNAL_DB_TESTS:-}" ]]; then
                pnpm --stream test:planetscale
              fi
            ;;
            int:cockroach) pnpm --stream vitest --reporter=verbose --silent=false run tests/cockroach ;;
            int:mssql) pnpm --stream vitest --reporter=verbose --silent=false run tests/mssql ;;
            int:sqlite) pnpm --stream vitest --reporter=verbose --silent=false run tests/sqlite ;;
            kit)
              cd ../drizzle-kit
              pnpm --stream vitest --reporter=verbose --silent=false run --exclude ./tests/cockroach/ --exclude ./tests/mssql/
            ;;
            kit:cockroach) cd ../drizzle-kit && pnpm --stream vitest --reporter=verbose --silent=false run ./tests/cockroach ;;
            kit:mssql) cd ../drizzle-kit && pnpm --stream vitest --reporter=verbose --silent=false run ./tests/mssql ;;
            orm|zod|seed|typebox|valibot|arktype)
              (cd ../drizzle-${{ matrix.shard }} && pnpm --stream test --reporter=verbose --silent=false)
            ;;
          
            int:bun)  bun test tests/bun/ ;;

            int:other)
              pnpm --stream vitest --reporter=verbose --silent=false run tests \
                --exclude ./tests/gel/ \
                --exclude ./tests/mysql/ \
                --exclude ./tests/cockroach/ \
                --exclude ./tests/singlestore/ \
                --exclude ./tests/mssql/ \
                --exclude ./tests/pg/ \
                --exclude ./tests/relational/ \
                --exclude ./tests/sqlite/
            ;;
            *) echo "Unknown shard: ${{matrix.shard}}"; exit 1 ;;
          esac

      - name: Stop DBs
        if: always() && ${{ matrix.dbs && join(matrix.dbs, ',') != '' }}
        shell: bash
        run: |
          set -euxo pipefail
          for db in ${{ join(matrix.dbs, ' ') }}; do
            case "$db" in
              postgres)            docker compose -f compose/postgres.yml down -v ;;
              postgres-postgis)    docker compose -f compose/postgres-postgis.yml up -d ;;
              mysql)               docker compose -f compose/mysql.yml down -v ;;
              singlestore)         docker compose -f compose/singlestore.yml down -v ;;
              mssql)               docker compose -f compose/mssql.yml down -v ;;
              cockroach)           docker compose -f compose/cockroach.yml down -v ;;
            esac
          done

  attw:
    needs: [prepare]
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name != github.repository
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    strategy:
      matrix:
        package: [drizzle-kit, drizzle-zod, drizzle-seed, drizzle-typebox, drizzle-valibot, drizzle-arktype, eslint-plugin-drizzle]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '24', registry-url: 'https://registry.npmjs.org' }
      - uses: pnpm/action-setup@v3
        with: { version: latest, run_install: false }
      - uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-
      - run: pnpm fetch && pnpm install --frozen-lockfile --prefer-offline
      - uses: oven-sh/setup-bun@v2
      - name: Download package tarball
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.package }}
          path: ./artifacts
      - name: Run @arethetypeswrong/cli
        working-directory: ${{ matrix.package }}
        run: bun --bun run ../attw-fork/src/run.ts ../artifacts/package.tgz

  attw-orm:
    needs: [prepare]
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name != github.repository
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    strategy:
      matrix:
        package: [node10, node16-cjs, node16-esm, bundler]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '24', registry-url: 'https://registry.npmjs.org' }
      - uses: pnpm/action-setup@v3
        with: { version: latest, run_install: false }
      - uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-
      - run: pnpm fetch && pnpm install --frozen-lockfile --prefer-offline
      - uses: oven-sh/setup-bun@v2
      - name: Download drizzle-orm tarball
        uses: actions/download-artifact@v4
        with:
          name: drizzle-orm
          path: ./artifacts
      - name: Run @arethetypeswrong/cli
        working-directory: drizzle-orm
        run: bun --bun run ../attw-fork/src/run.ts ../artifacts/package.tgz ${{ matrix.package }}

  release:
    needs: [test, prepare, attw, attw-orm]
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name != github.repository
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    permissions: { contents: read, id-token: write }
    strategy:
      matrix:
        package: [drizzle-orm, drizzle-kit, drizzle-zod, drizzle-seed, drizzle-typebox, drizzle-valibot, drizzle-arktype, eslint-plugin-drizzle]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '24', registry-url: 'https://registry.npmjs.org' }
      - name: Download package tarball
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.package }}
          path: ./artifacts
      - name: Check preconditions (from tarball)
        id: checks
        shell: bash
        run: |
          set -euxo pipefail
          version="$(tar -xOf ./artifacts/package.tgz package/package.json | jq -r .version)"
          tag="${GITHUB_REF_NAME}"
          is_published="$(npm view ${{ matrix.package }} versions --json | jq -r '.[] | select(. == "'$version'") | . == "'$version'"')"
          if [[ "$is_published" == "true" ]]; then
            echo "\`${{ matrix.package }}@$version\` already published, tagging \`$tag\`" >> $GITHUB_STEP_SUMMARY
            npm dist-tag add ${{ matrix.package }}@$version $tag || true
          else
            { echo "version=$version"; echo "tag=$tag"; echo "has_new_release=true"; } >> $GITHUB_OUTPUT
          fi
      - name: Publish (from tarball)
        if: steps.checks.outputs.has_new_release == 'true'
        shell: bash
        env: 
          NODE_AUTH_TOKEN: ${{ secrets.NPM_ACCESS_TOKEN }}
        run: |
          set -euxo pipefail
          npm publish ./artifacts/package.tgz --tag "${{ steps.checks.outputs.tag }}"
          echo "npm: \`${{ matrix.package }}@${{ steps.checks.outputs.tag }} | ${{ steps.checks.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
