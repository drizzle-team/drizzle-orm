# Relational Queries v2

```ts
import { drizzle } from 'drizzle-orm/…';
import { defineRelations } from 'drizzle-orm';
import * as p from 'drizzle-orm/pg-core';

export const users = p.pgTable('users', {
  id: p.integer().primaryKey(),
  name: p.text().notNull()
});
export const posts = p.pgTable('posts', {
  id: p.integer().primaryKey(),
  content: p.text().notNull(),
  ownerId: p.integer('owner_id'),
});

const relations = defineRelations({ users, posts }, (r) => ({
  posts: {
    author: r.one.users({
      from: r.posts.ownerId,
      to: r.users.id,
    }),
  }
}))

const db = drizzle(client, { relations });

const result = db.query.posts.findMany({
  with: {
    author: true,
  },
});
```

## API changes

### What is working differently from v1

One of the biggest updates were in Relations Schema definition

The first difference is that you no longer need to specify relations for each table separately in different objects and then pass them all to drizzle() along with your schema. In Relational Queries v2, you now have one dedicated place to specify all the relations for all the tables you need.

The r parameter in the callback provides comprehensive autocomplete functionality - including all tables from your schema and functions such as one, many, and through - essentially offering everything you need to specify your relations.

```ts
// relations.ts
import * as schema from "./schema"
import { defineRelations } from "drizzle-orm"
export const relations = defineRelations(schema, (r) => ({
    ...
}));

...

// index.ts
import { relations } from "./relations"
import { drizzle } from "drizzle-orm/..."
const db = drizzle(process.env.DATABASE_URL, { relations })
```

#### 1. One place for all your relations

```ts
import { defineRelations } from "drizzle-orm";
import * as schema from "./schema";
export const relations = defineRelations(schema, (r) => ({
  users: {
    invitee: r.one.users({
      from: r.users.invitedBy,
      to: r.users.id,
    }),
    posts: r.many.posts(),
  },
  posts: {
    author: r.one.users({
      from: r.posts.authorId,
      to: r.users.id,
    }),
  },
}));
```

#### 2. Define `many` without `one`

```ts
import { defineRelations } from "drizzle-orm";
import * as schema from "./schema";
export const relations = defineRelations(schema, (r) => ({
  users: {
    posts: r.many.posts({
      from: r.users.id,
      to: r.posts.authorId,
    }),
  },
}));
```

#### 3. No `modes` in drizzle()

We found a way to use the same strategy for all MySQL dialects, so there’s no need to specify them

#### 4. `from` and `to` upgrades

We’ve renamed fields to from and references to to, and we made both accept either a single value or an array

```ts
author: r.one.users({
  from: r.posts.authorId,
  to: r.users.id,
}),

// or

author: r.one.users({
  from: [r.posts.authorId],
  to: [r.users.id],
}),
```

#### 5. `relationName` -> `alias` rename

```ts
import { defineRelations } from "drizzle-orm";
import * as schema from "./schema";
export const relations = defineRelations(schema, (r) => ({
  posts: {
    author: r.one.users({
      from: r.posts.authorId,
      to: r.users.id,
      alias: "author_post",
    }),
  },
}));
```

#### 6. `where` is now object

```ts
const response = db.query.users.findMany({
  where: {
    id: 1,
  },
});
```

#### 7. `orderBy` is now object

```ts
const response = db.query.users.findMany({
  orderBy: { id: "asc" },
});
```

---

### What is new?

#### 1. through for many-to-many relations

```ts
import * as schema from './schema';
import { defineRelations } from 'drizzle-orm';
export const relations = defineRelations(schema, (r) => ({
  users: {
    groups: r.many.groups({
      from: r.users.id.through(r.usersToGroups.userId),
      to: r.groups.id.through(r.usersToGroups.groupId),
    }),
  },
  groups: {
    participants: r.many.users(),
  },
}));

...

// Query example
const response = await db.query.users.findMany({
  with: {
    groups: true,
  },
});
```

#### 2. Predefined filters

```ts
import * as schema from './schema';
import { defineRelations } from 'drizzle-orm';
export const relations = defineRelations(schema,
  (r) => ({
    groups: {
      verifiedUsers: r.many.users({
        from: r.groups.id.through(r.usersToGroups.groupId),
        to: r.users.id.through(r.usersToGroups.userId),
        where: {
          verified: true,
        },
      }),
    },
  })
);

... 

// Query example: get groups with all verified users
const response = await db.query.groups.findMany({
  with: {
    verifiedUsers: true,
  },
});
```

#### 3. Filtering by relations

Example: Get all users whose ID>10 and who have at least one post with content starting with “M”

```ts
const usersWithPosts = await db.query.usersTable.findMany({
  where: {
    id: {
      gt: 10
    }
  },
  posts: {
    content: {
      like: 'M%'
    }
  }
});
```

#### 4. Using `offset` on related objects

```ts
await db.query.posts.findMany({
  limit: 5,
  offset: 2, // correct ✅
  with: {
    comments: {
      offset: 3, // correct ✅
      limit: 3,
    },
  },
});
```

If you have any questions about these topics:

- How to migrate relations schema definition from v1 to v2
- How to migrate queries from v1 to v2
- Partial upgrade or how to stay on RQB v1 even after an upgrade?
- Internal type and import changes

you can refer to our migration guide, which contains all the relevant information and is available [here]()

# Breaking changes

## Column encoders and decoders changes

Several types in the PostgreSQL dialect across all drivers were incorrectly mapping `arrays` of `intervals`, `timestamps`, `dates`, and `datetimes`. As a result, Drizzle was responding with different runtime values than what the types were showing. We've fixed this issue, but if you were already mapping those responses after Drizzle and ignoring the types, this may be a breaking change for you. Please review this part in your projects

## Imports and internal types changes

1. Every `drizzle` database, `session`, `migrator` and `transaction` instance, gained 2 additional generic arguments for RQB v2 queries

```ts
// before

```

```ts
// now

```

2. Updated `DrizzleConfig` generic with `TRelations` argument and `relations: TRelations` field

```ts
// before

```

```ts
// now

```

3. The following entities have been moved from `drizzle-orm` and `drizzle-orm/relations` to `drizzle-orm/_relations`. The original imports now include new types used by Relational Queries v2, so make sure to update your imports if you intend to use the older types:

```
- `Relation`
- `Relations`
- `One`
- `Many`
- `TableRelationsKeysOnly`
- `ExtractTableRelationsFromSchema`
- `ExtractObjectValues`
- `ExtractRelationsFromTableExtraConfigSchema`
- `getOperators`
- `Operators`
- `getOrderByOperators`
- `OrderByOperators`
- `FindTableByDBName`
- `DBQueryConfig`
- `TableRelationalConfig`
- `TablesRelationalConfig`
- `RelationalSchemaConfig`
- `ExtractTablesWithRelations`
- `ReturnTypeOrValue`
- `BuildRelationResult`
- `NonUndefinedKeysOnly`
- `BuildQueryResult`
- `RelationConfig`
- `extractTablesRelationalConfig`
- `relations`
- `createOne`
- `createMany`
- `NormalizedRelation`
- `normalizeRelation`
- `createTableRelationsHelpers`
- `TableRelationsHelpers`
- `BuildRelationalQueryResult`
- `mapRelationalRow`
```

4. In the same manner, `${dialect}-core/query-builders/query` files were moved to `${dialect}-core/query-builders/_query`
with RQB v2's alternatives being put in their place

```ts
// before


```

```ts
// now


```
